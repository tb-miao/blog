---
import { Icon } from "astro-icon/components";
import { profileConfig, umamiConfig } from "../../config";
import { url } from "../../utils/url-utils";
import ImageWrapper from "../misc/ImageWrapper.astro";
import TypewriterText from "../TypewriterText.astro";

// è§£æ umami
const umamiEnabled = umamiConfig.enabled || false;
const umamiWebsiteId =
	umamiConfig.scripts.match(/data-website-id="([^"]+)"/)?.[1] || "";
const umamiApiKey = umamiConfig.apiKey || "";
const umamiBaseUrl = umamiConfig.baseUrl || "";
---

<div class="card-base p-3">
    <a aria-label="Go to About Page" href={url('/about/')}
       class="group block relative mx-auto mt-1 lg:mx-0 lg:mt-0 mb-3
       max-w-[12rem] lg:max-w-none overflow-hidden rounded-xl active:scale-95">
        <div class="absolute transition pointer-events-none group-hover:bg-black/30 group-active:bg-black/50
        w-full h-full z-50 flex items-center justify-center">
            <Icon name="fa6-regular:address-card"
                  class="transition opacity-0 scale-90 group-hover:scale-100 group-hover:opacity-100 text-white text-5xl">
            </Icon>
        </div>
        <ImageWrapper src={profileConfig.avatar || ""} alt="Profile Image of the Author" class="mx-auto lg:w-full h-full lg:mt-0 "></ImageWrapper>
    </a>
    <div class="px-2">
        <div class="font-bold text-xl text-center mb-1 dark:text-neutral-50 transition">{profileConfig.name}</div>
        <div class="h-1 w-5 bg-[var(--primary)] mx-auto rounded-full mb-2 transition"></div>
        <div class="text-center text-neutral-400 mb-2.5 transition">
            {profileConfig.typewriter?.enable ? (
                <TypewriterText 
                    text={profileConfig.bio || ""}
                    speed={profileConfig.typewriter.speed}
                    class="inline-block"
                />
            ) : (
                profileConfig.bio
            )}
        </div>
        <div class="flex gap-2 justify-center mb-1">
            {profileConfig.links.length > 1 && profileConfig.links.map(item =>
                    <a rel="me" aria-label={item.name} href={item.url} target="_blank" class="btn-regular rounded-lg h-10 w-10 active:scale-90">
                        <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                    </a>
            )}
            {profileConfig.links.length == 1 && <a rel="me" aria-label={profileConfig.links[0].name} href={profileConfig.links[0].url} target="_blank"
                                            class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95">
                <Icon name={profileConfig.links[0].icon} class="text-[1.5rem]"></Icon>
                {profileConfig.links[0].name}
            </a>}
        </div>
        {umamiEnabled && (
            <div id="umami-stats-container" class="mt-4 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl border border-blue-200 dark:border-blue-800/30 hover:shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer relative overflow-hidden group" title="ç»Ÿè®¡æ•°æ®">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full animate-[shimmer_2s_infinite]"></div>
                <div class="flex items-center justify-center gap-2 mb-3">
                    <div class="relative">
                        <Icon name="fa6-solid:chart-pie" class="text-blue-600 dark:text-blue-400 text-sm" />
                        <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                    <span class="text-sm font-semibold text-blue-700 dark:text-blue-300">å®æ—¶ç»Ÿè®¡</span>
                    <button id="refresh-button" onclick="fetchSiteStats(true); resetAutoRefresh();" class="ml-2 p-1 rounded-full bg-blue-100 dark:bg-blue-900/30 hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-all duration-200 opacity-0 group-hover:opacity-100 disabled:opacity-50 disabled:cursor-not-allowed" title="åˆ·æ–°æ•°æ®">
                        <Icon name="fa6-solid:arrows-rotate" class="text-blue-600 dark:text-blue-400 text-xs" />
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="text-center">
                        <div class="text-lg font-bold text-gray-700 dark:text-gray-300 transition-all duration-300" id="pageviews-count">-</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">æµè§ˆé‡</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-gray-700 dark:text-gray-300 transition-all duration-300" id="visits-count">-</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">è®¿é—®æ¬¡æ•°</div>
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <Icon name="fa6-solid:chart-line" class="inline-block mr-1 text-blue-500 dark:text-blue-400 text-sm" />
                    <span id="site-stats-display" class="text-xs text-blue-600 dark:text-blue-400">æ•°æ®åŠ è½½ä¸­...</span>
                </div>
                <div class="mt-1 text-center">
                    <span id="last-update-time" class="text-xs text-gray-400 dark:text-gray-500">é¦–æ¬¡åŠ è½½ä¸­...</span>
                </div>
            </div>
        )}
        {profileConfig.timeProgress?.enable && (
            <div id="time-progress-container" class="mt-3 p-3 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl border border-green-200 dark:border-green-800/30 hover:shadow-md hover:scale-105 transition-all duration-300 cursor-pointer group">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <div class="relative">
                        <Icon name="fa6-solid:clock" class="text-green-600 dark:text-green-400 text-sm" />
                        <div class="absolute -top-1 -right-1 w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                    </div>
                    <span class="text-sm font-semibold text-green-700 dark:text-green-300">æ—¶é—´è¿›åº¦</span>
                    <div class="ml-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <Icon name="fa6-solid:arrows-rotate" class="text-green-400 dark:text-green-500 text-xs" />
                    </div>
                </div>
                
                {profileConfig.timeProgress?.showYearProgress && (
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-600 dark:text-gray-400">å¹´åº¦è¿›åº¦</span>
                            <span id="year-progress-percent" class="text-xs font-semibold text-gray-700 dark:text-gray-300">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div id="year-progress-bar" class="bg-gradient-to-r from-green-400 to-emerald-500 h-2 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-1">
                            <span id="year-progress-text" class="text-xs text-gray-500 dark:text-gray-400">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                )}
                
                {profileConfig.timeProgress?.showDayProgress && (
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-600 dark:text-gray-400">ä»Šæ—¥è¿›åº¦</span>
                            <span id="day-progress-percent" class="text-xs font-semibold text-gray-700 dark:text-gray-300">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div id="day-progress-bar" class="bg-gradient-to-r from-blue-400 to-cyan-500 h-2 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-1">
                            <span id="day-progress-text" class="text-xs text-gray-500 dark:text-gray-400">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                )}
                <div class="mt-1 text-center">
                    <span class="text-xs text-gray-400 dark:text-gray-500">é»˜è®¤åˆ·æ–°æ—¶é—´ï¼š1åˆ†é’Ÿ</span>
                </div>
            </div>
        )}
                    <!-- æœ€æ–° Commit æäº¤ä¿¡æ¯ -->
        <div id="github-commit-container" class="mt-3 p-3 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800/30 dark:to-gray-900/30 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-md hover:scale-105 transition-all duration-300 cursor-pointer group">
            <div class="flex items-center justify-center gap-2 mb-2">
                <div class="relative">
                    <Icon name="fa6-brands:git-alt" class="text-purple-600 dark:text-purple-400 text-lg" />
                    <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                </div>
                <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">æœ€æ–°æäº¤</span>
                <div class="ml-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                    <Icon name="fa6-brands:git-alt" class="text-gray-400 dark:text-gray-500 text-xs" />
                </div>
            </div>
            
            <div class="text-center space-y-1">
                <div class="flex items-center justify-center gap-2">
                    <a id="github-commit-link" href="#" class="group/link">
                        <span id="github-commit-hash" class="px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-md text-xs font-mono font-bold hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors duration-200">
                            åŠ è½½ä¸­...
                        </span>
                    </a>
                    <span id="github-commit-status" class="px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-full text-xs font-medium animate-pulse">
                        æœ€æ–°
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

{profileConfig.timeProgress?.enable && (
    <script is:inline define:vars={{ timeProgressConfig: profileConfig.timeProgress }}>
        // è®¡ç®—æ—¶é—´è¿›åº¦ç›¸å…³å‡½æ•°
        function updateTimeProgress() {
            const now = new Date();
            
            // è®¡ç®—å¹´åº¦è¿›åº¦
            if (timeProgressConfig?.showYearProgress) {
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                const endOfYear = new Date(now.getFullYear() + 1, 0, 1);
                const yearProgress = (now - startOfYear) / (endOfYear - startOfYear);
                
                const yearProgressPercent = Math.round(yearProgress * 100);
                const yearProgressBar = document.getElementById('year-progress-bar');
                const yearProgressPercentEl = document.getElementById('year-progress-percent');
                const yearProgressText = document.getElementById('year-progress-text');
                
                if (yearProgressBar) {
                    yearProgressBar.style.width = yearProgressPercent + '%';
                }
                if (yearProgressPercentEl) {
                    yearProgressPercentEl.textContent = yearProgressPercent + '%';
                }
                if (yearProgressText) {
                    const daysPassed = Math.floor((now - startOfYear) / (1000 * 60 * 60 * 24));
                    const totalDays = Math.floor((endOfYear - startOfYear) / (1000 * 60 * 60 * 24));
                    yearProgressText.textContent = `${daysPassed}/${totalDays} å¤©`;
                }
            }
            
            // è®¡ç®—ä»Šæ—¥è¿›åº¦
            if (timeProgressConfig?.showDayProgress) {
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                const dayProgress = (now - startOfDay) / (endOfDay - startOfDay);
                
                const dayProgressPercent = Math.round(dayProgress * 100);
                const dayProgressBar = document.getElementById('day-progress-bar');
                const dayProgressPercentEl = document.getElementById('day-progress-percent');
                const dayProgressText = document.getElementById('day-progress-text');
                
                if (dayProgressBar) {
                    dayProgressBar.style.width = dayProgressPercent + '%';
                }
                if (dayProgressPercentEl) {
                    dayProgressPercentEl.textContent = dayProgressPercent + '%';
                }
                if (dayProgressText) {
                    const hours = now.getHours();
                    const minutes = now.getMinutes();
                    const seconds = now.getSeconds();
                    dayProgressText.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }
        }
        
        // æ·»åŠ ç‚¹å‡»åˆ·æ–°åŠŸèƒ½
        function addTimeProgressRefresh() {
            const timeProgressContainer = document.getElementById('time-progress-container');
            if (timeProgressContainer) {
                timeProgressContainer.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯è¿›åº¦æ¡æˆ–å…¶ä»–å­å…ƒç´ ï¼Œä¸è§¦å‘åˆ·æ–°åŠ¨ç”»
                    if (e.target.closest('.rounded-full')) {
                        return;
                    }
                    
                    // æ·»åŠ åˆ·æ–°åŠ¨ç”»
                    this.classList.add('animate-pulse');
                    
                    // ç«‹å³æ›´æ–°ä¸€æ¬¡
                    updateTimeProgress();
                    
                    // ç§»é™¤åŠ¨ç”»ç±»
                    setTimeout(() => {
                        this.classList.remove('animate-pulse');
                    }, 1000);
                });
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                updateTimeProgress();
                addTimeProgressRefresh();
            });
        } else {
            updateTimeProgress();
            addTimeProgressRefresh();
        }
        
        // è®¾ç½®å®šæ—¶æ›´æ–°
        const updateInterval = timeProgressConfig?.updateInterval || 60000;
        setInterval(updateTimeProgress, updateInterval);
    </script>
)}

{umamiEnabled && (
    <script is:inline define:vars={{ umamiBaseUrl, umamiApiKey, umamiWebsiteId, umamiConfig }}>
        // å®¢æˆ·ç«¯ç»Ÿè®¡æ–‡æ¡ˆç”Ÿæˆå‡½æ•°
        function generateStatsText(pageViews, visits) {
            return ` å®æ—¶æ•°æ®`;
        }
        
        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const lastUpdateElement = document.getElementById('last-update-time');
            if (lastUpdateElement) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                lastUpdateElement.textContent = `æœ€åæ›´æ–°: ${timeStr}`;
            }
        }
        
        // æ•°å­—æ ¼å¼åŒ–å‡½æ•°
        function formatNumber(num) {
            if (num >= 10000) {
                return (num / 10000).toFixed(1) + 'ä¸‡';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        // è·å–è®¿é—®é‡ç»Ÿè®¡
        async function fetchSiteStats(isManualRefresh = false) {
            if (!umamiConfig.enabled) {
                return;
            }
            
            // è·å–DOMå…ƒç´ 
            const pageviewsElement = document.getElementById('pageviews-count');
            const visitsElement = document.getElementById('visits-count');
            const displayElement = document.getElementById('site-stats-display');
            const statsContainer = document.getElementById('umami-stats-container');
            const refreshButton = document.getElementById('refresh-button');
            
            // é˜²æ­¢é‡å¤ç‚¹å‡» - å¦‚æœæ­£åœ¨åˆ·æ–°åˆ™ç›´æ¥è¿”å›
            if (statsContainer && statsContainer.classList.contains('refreshing')) {
                return;
            }
            
            // æ·»åŠ åˆ·æ–°çŠ¶æ€ç±»
            if (statsContainer) {
                statsContainer.classList.add('refreshing');
            }
            
            // ç¦ç”¨åˆ·æ–°æŒ‰é’®
            if (refreshButton) {
                refreshButton.disabled = true;
                refreshButton.classList.add('animate-spin');
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (isManualRefresh && displayElement) {
                displayElement.innerHTML = 'ğŸ”„ æ­£åœ¨åˆ·æ–°æ•°æ®...';
            }
            
            // æ·»åŠ åŠ è½½åŠ¨ç”»ç±»
            if (statsContainer) {
                statsContainer.classList.add('animate-pulse');
            }
            
            try {
                // è°ƒç”¨å…¨å±€å·¥å…·è·å– Umami ç»Ÿè®¡æ•°æ®
                const stats = await getUmamiWebsiteStats(umamiBaseUrl, umamiApiKey, umamiWebsiteId);
                
                // ä»è¿”å›çš„æ•°æ®ä¸­æå–é¡µé¢æµè§ˆé‡å’Œè®¿å®¢æ•°
                const pageViews = stats.pageviews || 0;
                const visits = stats.visits || 0;
                
                // æ·»åŠ åŠ è½½åŠ¨ç”»æ•ˆæœ
                if (pageviewsElement) {
                    pageviewsElement.style.opacity = '0.3';
                    setTimeout(() => {
                        pageviewsElement.textContent = formatNumber(pageViews);
                        pageviewsElement.style.opacity = '1';
                        pageviewsElement.classList.add('animate-bounce');
                        setTimeout(() => pageviewsElement.classList.remove('animate-bounce'), 600);
                    }, 300);
                }
                if (visitsElement) {
                    visitsElement.style.opacity = '0.3';
                    setTimeout(() => {
                        visitsElement.textContent = formatNumber(visits);
                        visitsElement.style.opacity = '1';
                        visitsElement.classList.add('animate-bounce');
                        setTimeout(() => visitsElement.classList.remove('animate-bounce'), 600);
                    }, 300);
                }
                if (displayElement) {
                    displayElement.textContent = generateStatsText(pageViews, visits);
                }
                
                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                updateLastUpdateTime();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                if (isManualRefresh && displayElement) {
                    const originalText = displayElement.textContent;
                    displayElement.innerHTML = 'âœ… æ•°æ®å·²æ›´æ–°';
                    setTimeout(() => {
                        displayElement.textContent = originalText;
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Error fetching site stats:', error);
                
                if (displayElement) {
                    displayElement.innerHTML = 'âŒ æ•°æ®è·å–å¤±è´¥';
                }
                if (pageviewsElement) {
                    pageviewsElement.textContent = '-';
                }
                if (visitsElement) {
                    visitsElement.textContent = '-';
                }
                
                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´ï¼ˆé”™è¯¯æ—¶ä¹Ÿè¦æ›´æ–°ï¼‰
                updateLastUpdateTime();
                
                // 3ç§’åæ¢å¤åŸå§‹çŠ¶æ€
                setTimeout(() => {
                    if (displayElement) {
                        displayElement.textContent = generateStatsText(0, 0);
                    }
                }, 3000);
                
            } finally {
                // ç§»é™¤åŠ è½½åŠ¨ç”»ç±»å’Œåˆ·æ–°çŠ¶æ€
                if (statsContainer) {
                    statsContainer.classList.remove('animate-pulse', 'refreshing');
                }
                
                // é‡æ–°å¯ç”¨åˆ·æ–°æŒ‰é’®
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.classList.remove('animate-spin');
                }
                
                // 5ç§’åç§»é™¤æˆåŠŸæç¤ºï¼Œæ¢å¤åŸå§‹çŠ¶æ€
                if (isManualRefresh) {
                    setTimeout(() => {
                        if (displayElement) {
                            displayElement.textContent = generateStatsText(0, 0);
                        }
                    }, 5000);
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè·å–ç»Ÿè®¡æ•°æ®
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                fetchSiteStats();
                updateLastUpdateTime();
            });
        } else {
            fetchSiteStats();
            updateLastUpdateTime();
        }
        
        // è®¾ç½®è‡ªåŠ¨åˆ·æ–° - æ¯30ç§’è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡æ•°æ®
        let autoRefreshInterval = setInterval(() => {
            fetchSiteStats(false); // falseè¡¨ç¤ºè‡ªåŠ¨åˆ·æ–°ï¼Œä¸æ˜¾ç¤ºæˆåŠŸæç¤º
        }, 30000);
        
        // å½“ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°æ—¶ï¼Œé‡ç½®è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
        function resetAutoRefresh() {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                fetchSiteStats(false);
            }, 30000);
        }
        
        // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ - æŒ‰Ré”®åˆ·æ–°ç»Ÿè®¡æ•°æ®
        document.addEventListener('keydown', function(event) {
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº†Ré”®ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ä¸”æ²¡æœ‰æŒ‰ä¸‹å…¶ä»–ä¿®é¥°é”®
            if ((event.key === 'r' || event.key === 'R') && 
                !event.ctrlKey && !event.altKey && !event.shiftKey && !event.metaKey) {
                
                // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨ç»Ÿè®¡åŒºåŸŸå†…
                const statsContainer = document.getElementById('umami-stats-container');
                if (statsContainer && statsContainer.matches(':hover')) {
                    event.preventDefault();
                    fetchSiteStats(true);
                    resetAutoRefresh(); // é‡ç½®è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
                }
            }
        });
    </script>
)}

<style>
@keyframes shimmer {
    0% {
        transform: translateX(-100%);
    }
    100% {
        transform: translateX(100%);
    }
}

/* GitHub Commit åŒºåŸŸæ ·å¼å¢å¼º */
#github-commit-container {
    position: relative;
    overflow: hidden;
}

#github-commit-container:hover {
    transform: translateY(-1px);
}

#github-commit-hash {
    font-family: 'Courier New', monospace;
    letter-spacing: -0.5px;
}

#github-commit-message {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* æš—è‰²æ¨¡å¼ä¸‹çš„æ‚¬åœæ•ˆæœ */
.dark #github-commit-container:hover {
    border-color: #4b5563;
}

/* çŠ¶æ€æ ‡ç­¾åŠ¨ç”» */
#github-commit-status {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* å¤–éƒ¨é“¾æ¥å›¾æ ‡åŠ¨ç”» */
#github-commit-container:hover .group-hover\:opacity-100 {
    transform: translateX(2px);
    transition: all 0.2s ease;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 640px) {
    #github-commit-message {
        max-width: 150px;
    }
}

/* å·¥å…·æç¤ºæ ·å¼ */
#github-commit-message .absolute {
    filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
}

#github-commit-message:hover .absolute {
    animation: tooltipFadeIn 0.2s ease-out;
}

@keyframes tooltipFadeIn {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(4px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes shimmer {
    0% {
        transform: translateX(-100%);
    }
    100% {
        transform: translateX(100%);
    }
}

/* æ—¶é—´è¿›åº¦ç»„ä»¶æ ·å¼ */
#time-progress-container {
    position: relative;
    overflow: hidden;
}

#time-progress-container:hover {
    transform: translateY(-1px);
}

/* è¿›åº¦æ¡åŠ¨ç”»æ•ˆæœ */
#year-progress-bar, #day-progress-bar {
    position: relative;
    overflow: hidden;
}

#year-progress-bar::after, #day-progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
    );
    animation: shimmer 2s infinite;
}

/* æš—è‰²æ¨¡å¼ä¸‹çš„è¿›åº¦æ¡æ•ˆæœ */
.dark #year-progress-bar::after, .dark #day-progress-bar::after {
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent
    );
}

/* è¿›åº¦æ¡æ‚¬åœæ•ˆæœ */
#year-progress-bar:hover, #day-progress-bar:hover {
    filter: brightness(1.1);
}

/* æ—¶é—´æ–‡æœ¬æ ·å¼ */
#year-progress-text, #day-progress-text {
    font-family: 'Courier New', monospace;
    letter-spacing: 0.5px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 640px) {
    #time-progress-container {
        padding: 0.75rem;
    }
}
</style>

<!-- è·å– Commit ä¿¡æ¯ via API -->
<script>
    async function loadCommitStats() {
        try {
            const hashElement = document.getElementById('github-commit-hash');
            const link = document.getElementById('github-commit-link');
            const statusElement = document.getElementById('github-commit-status');
            
            // ç¬¬ä¸€æ­¥ï¼šè°ƒç”¨ API                
            const githubResponse = await fetch(`https://api.github.com/repos/tb-miao/blog/commits?per_page=1`);

            if (!githubResponse.ok) {
                throw new Error('è·å–ä¿¡æ¯å¤±è´¥');
            }

            let Data = await githubResponse.json();
            Data = Data[0];
            
            // ç¬¬äºŒæ­¥ï¼šè·å– Commit æ•°æ®
            const latestCommit = Data;
            
            const commitData = {
                hash: latestCommit.sha.slice(0, 7),
                fullHash: latestCommit.sha,
                message: latestCommit.commit.message.split('\n')[0],
                author: latestCommit.commit.author.name,
                date: latestCommit.commit.author.date,
                url: latestCommit.html_url
            };
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const commitDate = new Date(commitData.date);
            const now = new Date();
            const timeDiff = now - commitDate;
            const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            let formattedDate = '';
            if (daysDiff === 0) {
                formattedDate = 'ä»Šå¤©';
            } else if (daysDiff === 1) {
                formattedDate = 'æ˜¨å¤©';
            } else if (daysDiff < 7) {
                formattedDate = `${daysDiff}å¤©å‰`;
            } else {
                formattedDate = commitDate.toLocaleDateString('zh-CN', { 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
            
            // æ›´æ–°çŠ¶æ€æ ‡ç­¾
            if (statusElement) {
                if (daysDiff === 0) {
                    statusElement.textContent = 'æœ€æ–°';
                    statusElement.className = 'px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full text-xs font-medium animate-pulse';
                } else if (daysDiff === 1) {
                    statusElement.textContent = 'æ˜¨å¤©';
                    statusElement.className = 'px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-full text-xs font-medium';
                } else {
                    statusElement.textContent = `${daysDiff}å¤©å‰`;
                    statusElement.className = 'px-2 py-0.5 bg-gray-100 dark:bg-gray-900/30 text-gray-700 dark:text-gray-300 rounded-full text-xs font-medium';
                }
            }
            
            // æ›´æ–°å„ä¸ªå…ƒç´ 
            if (hashElement) {
                hashElement.textContent = commitData.hash;
                hashElement.classList.add('animate-pulse');
                setTimeout(() => {
                    hashElement.classList.remove('animate-pulse');
                }, 1000);
            }
            
            if (link) {
                const gurl = "/info/";
                link.href = gurl;
                link.title = `æäº¤æ—¶é—´: ${commitDate.toLocaleString('zh-CN')}\næäº¤æ¶ˆæ¯: ${commitData.message}\nç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…`;
            }
            
        } catch (error) {
            console.error('è·å– Commit ä¿¡æ¯å¤±è´¥:', error);  
            
            const hashElement = document.getElementById('github-commit-hash');
            const statusElement = document.getElementById('github-commit-status');
            const loadingElement = document.getElementById('github-commit-loading');
            
            if (hashElement) {
                hashElement.textContent = 'è·å–å¤±è´¥';
                hashElement.className = 'px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-md text-xs font-mono font-bold';
            }
            
            if (statusElement) {
                statusElement.textContent = 'é”™è¯¯';
                statusElement.className = 'px-2 py-0.5 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full text-xs font-medium';
            }
            
            // éšè—åŠ è½½åŠ¨ç”»
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè·å– Commit æ•°æ®
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadCommitStats);
    } else {
        loadCommitStats();
    }
    
    // æ·»åŠ ç‚¹å‡»åˆ·æ–°åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        const commitContainer = document.getElementById('github-commit-container');
        if (commitContainer) {
            commitContainer.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯é“¾æ¥ï¼Œä¸è§¦å‘åˆ·æ–°
                if (e.target.closest('a')) {
                    return;
                }
                
                // æ·»åŠ åˆ·æ–°åŠ¨ç”»
                this.classList.add('animate-pulse');
                
                // é‡æ–°åŠ è½½æ•°æ®
                loadCommitStats();
                
                // ç§»é™¤åŠ¨ç”»ç±»
                setTimeout(() => {
                    this.classList.remove('animate-pulse');
                }, 1000);
            });
        }
    });
</script>