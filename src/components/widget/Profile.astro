---
import { Icon } from "astro-icon/components";
import { profileConfig, umamiConfig } from "../../config";
import { url } from "../../utils/url-utils";
import ImageWrapper from "../misc/ImageWrapper.astro";
import TypewriterText from "../TypewriterText.astro";

// 解析 umami
const umamiEnabled = umamiConfig.enabled || false;
const umamiWebsiteId =
	umamiConfig.scripts.match(/data-website-id="([^"]+)"/)?.[1] || "";
const umamiApiKey = umamiConfig.apiKey || "";
const umamiBaseUrl = umamiConfig.baseUrl || "";
---

<div class="card-base p-3">
    <a aria-label="Go to About Page" href={url('/about/')}
       class="group block relative mx-auto mt-1 lg:mx-0 lg:mt-0 mb-3
       max-w-[12rem] lg:max-w-none overflow-hidden rounded-xl active:scale-95">
        <div class="absolute transition pointer-events-none group-hover:bg-black/30 group-active:bg-black/50
        w-full h-full z-50 flex items-center justify-center">
            <Icon name="fa6-regular:address-card"
                  class="transition opacity-0 scale-90 group-hover:scale-100 group-hover:opacity-100 text-white text-5xl">
            </Icon>
        </div>
        <ImageWrapper src={profileConfig.avatar || ""} alt="Profile Image of the Author" class="mx-auto lg:w-full h-full lg:mt-0 "></ImageWrapper>
    </a>
    <div class="px-2">
        <div class="font-bold text-xl text-center mb-1 dark:text-neutral-50 transition">{profileConfig.name}</div>
        <div class="h-1 w-5 bg-[var(--primary)] mx-auto rounded-full mb-2 transition"></div>
        <div class="text-center text-neutral-400 mb-2.5 transition">
            {profileConfig.typewriter?.enable ? (
                <TypewriterText 
                    text={profileConfig.bio || ""}
                    speed={profileConfig.typewriter.speed}
                    class="inline-block"
                />
            ) : (
                profileConfig.bio
            )}
        </div>
        <div class="flex gap-2 justify-center mb-1">
            {profileConfig.links.length > 1 && profileConfig.links.map(item =>
                    <a rel="me" aria-label={item.name} href={item.url} target="_blank" class="btn-regular rounded-lg h-10 w-10 active:scale-90">
                        <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                    </a>
            )}
            {profileConfig.links.length == 1 && <a rel="me" aria-label={profileConfig.links[0].name} href={profileConfig.links[0].url} target="_blank"
                                            class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95">
                <Icon name={profileConfig.links[0].icon} class="text-[1.5rem]"></Icon>
                {profileConfig.links[0].name}
            </a>}
        </div>
        {umamiEnabled && (
            <div id="umami-stats-container" class="mt-4 p-3 bg-gray-50 dark:bg-gray-800/30 rounded-lg border border-gray-200 dark:border-gray-700" title="网站统计">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <Icon name="fa6-solid:chart-pie" class="text-gray-600 dark:text-gray-400 text-sm" />
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">网站统计</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="text-center">
                        <div class="text-base font-semibold text-gray-700 dark:text-gray-300" id="pageviews-count">-</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">浏览量</div>
                    </div>
                    <div class="text-center">
                        <div class="text-base font-semibold text-gray-700 dark:text-gray-300" id="visits-count">-</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">访客数</div>
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <span id="site-stats-display" class="text-xs text-gray-500 dark:text-gray-400">加载中...</span>
                </div>
            </div>
        )}
        
            <!-- 最新 Commit 提交信息 -->
            <div id="github-commit-container" class="mt-3 p-3 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800/30 dark:to-gray-900/30 rounded-xl border border-gray-200 ">
            <div class="flex items-center justify-center gap-2 mb-2">
                <div class="relative">
                    <Icon name="fa6-brands:git-alt" class="text-purple-600 dark:text-purple-400 text-lg" />
                    <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                </div>
                <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">最新提交</span>
                <div class="ml-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                    <Icon name="fa6-brands:git-alt" class="text-gray-400 dark:text-gray-500 text-xs" />
                </div>
            </div>
            
            <div class="text-center space-y-1">
                <div class="flex items-center justify-center gap-2">
                    <a id="github-commit-link" href="#" class="group/link">
                        <span id="github-commit-hash" class="px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-md text-xs font-mono font-bold hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors duration-200">
                            加载中...
                        </span>
                    </a>
                    <span id="github-commit-status" class="px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-full text-xs font-medium animate-pulse">
                        最新
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

{umamiEnabled && (
    <script is:inline define:vars={{ umamiBaseUrl, umamiApiKey, umamiWebsiteId, umamiConfig }}>

        // 数字格式化函数，全部显示数字，使用千位分隔符
        function formatNumber(num) {
            return num.toLocaleString();
            
        }
        
        // 获取访问量统计
        async function fetchSiteStats() {
            if (!umamiConfig.enabled) {
                return;
            }
            
            const pageviewsElement = document.getElementById('pageviews-count');
            const visitsElement = document.getElementById('visits-count');
            const displayElement = document.getElementById('site-stats-display');
            
            try {
                const stats = await getUmamiWebsiteStats(umamiBaseUrl, umamiApiKey, umamiWebsiteId);
                const pageViews = stats.pageviews || 0;
                const visits = stats.visits || 0;
                
                if (pageviewsElement) {
                    pageviewsElement.textContent = formatNumber(pageViews);
                }
                if (visitsElement) {
                    visitsElement.textContent = formatNumber(visits);
                }
                if (displayElement) {
                    displayElement.textContent = '数据已加载';
                }
                
            } catch (error) {
                console.error('获取统计数据失败:', error);
                if (displayElement) {
                    displayElement.textContent = '加载失败';
                }
                if (pageviewsElement) {
                    pageviewsElement.textContent = '-';
                }
                if (visitsElement) {
                    visitsElement.textContent = '-';
                }
            }
        }

        // 页面加载完成后获取统计数据
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fetchSiteStats);
        } else {
            fetchSiteStats();
        }
        
        // 每10秒自动更新一次数据
        setInterval(fetchSiteStats, 10000);
    </script>
)}

<!-- 获取 Commit 信息 via API -->
<script>
    async function loadCommitStats() {
        try {
            const hashElement = document.getElementById('github-commit-hash');
            const link = document.getElementById('github-commit-link');
            const statusElement = document.getElementById('github-commit-status');
            
            // 配置 GitHub 仓库信息（需要根据实际情况修改）
            const githubRepoOwner = 'tb-miao'; // 仓库所有者
            const githubRepoName = 'blog';     // 仓库名称
            
            // 第一步：调用 GitHub API
            const githubResponse = await fetch(`https://api.github.com/repos/${githubRepoOwner}/${githubRepoName}/commits?per_page=1`);

            // 检查响应状态
            if (!githubResponse.ok) {
                if (githubResponse.status === 403) {
                    throw new Error('GitHub API 速率限制，请稍后重试');
                } else if (githubResponse.status === 404) {
                    throw new Error('仓库不存在或无法访问');
                } else {
                    throw new Error(`获取信息失败 (HTTP ${githubResponse.status})`);
                }
            }

            // 检查响应内容类型
            const contentType = githubResponse.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('API 返回了非 JSON 数据');
            }

            const commitsData = await githubResponse.json();
            
            // 检查返回的数据是否有效
            if (!Array.isArray(commitsData) || commitsData.length === 0) {
                throw new Error('没有找到提交记录');
            }

            const latestCommit = commitsData[0];
            
            // 验证提交数据
            if (!latestCommit || !latestCommit.sha || !latestCommit.commit) {
                throw new Error('提交数据格式错误');
            }
            
            const commitData = {
                hash: latestCommit.sha.slice(0, 7),
                fullHash: latestCommit.sha,
                message: latestCommit.commit.message.split('\n')[0],
                author: latestCommit.commit.author?.name || '未知作者',
                date: latestCommit.commit.author?.date || new Date().toISOString(),
                url: latestCommit.html_url
            };
            
            // 格式化日期
            const commitDate = new Date(commitData.date);
            const now = new Date();
            const timeDiff = now - commitDate;
            const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            // 更新状态标签
            if (statusElement) {
                if (daysDiff === 0) {
                    statusElement.textContent = '最新';
                    statusElement.className = 'px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full text-xs font-medium animate-pulse';
                } else if (daysDiff === 1) {
                    statusElement.textContent = '昨天';
                    statusElement.className = 'px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-full text-xs font-medium';
                } else if (daysDiff < 7) {
                    statusElement.textContent = `${daysDiff}天前`;
                    statusElement.className = 'px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-full text-xs font-medium';
                } else {
                    statusElement.textContent = `${daysDiff}天前`;
                    statusElement.className = 'px-2 py-0.5 bg-gray-100 dark:bg-gray-900/30 text-gray-700 dark:text-gray-300 rounded-full text-xs font-medium';
                }
            }
            
            // 更新各个元素
            if (hashElement) {
                hashElement.textContent = commitData.hash;
                hashElement.classList.add('animate-pulse');
                setTimeout(() => {
                    hashElement.classList.remove('animate-pulse');
                }, 1000);
            }
            
            if (link) {
                // 修复：使用实际的/info/链接
                link.href = '/info/';
                link.rel = 'noopener noreferrer'; // 安全设置
                link.title = `提交时间: ${commitDate.toLocaleString('zh-CN')}\n提交消息: ${commitData.message}\n作者: ${commitData.author}\n点击查看提交详情`;
            }
            
        } catch (error) {
            console.error('获取 Commit 信息失败:', error);  
            
            const hashElement = document.getElementById('github-commit-hash');
            const statusElement = document.getElementById('github-commit-status');
            
            if (hashElement) {
                hashElement.textContent = '获取失败';
                hashElement.className = 'px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-md text-xs font-mono font-bold';
            }
            
            if (statusElement) {
                statusElement.textContent = '错误';
                statusElement.className = 'px-2 py-0.5 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full text-xs font-medium';
            }
        }
    }

    // 页面加载完成后获取 Commit 数据
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadCommitStats);
    } else {
        loadCommitStats();
    }
    
    // 添加点击刷新功能
    document.addEventListener('DOMContentLoaded', function() {
        const commitContainer = document.getElementById('github-commit-container');
        if (commitContainer) {
            commitContainer.addEventListener('click', function(e) {
                // 如果点击的是链接，不触发刷新
                if (e.target.closest('a')) {
                    return;
                }
                
                // 添加刷新动画
                this.classList.add('animate-pulse');
                
                // 重新加载数据
                loadCommitStats();
                
                // 移除动画类
                setTimeout(() => {
                    this.classList.remove('animate-pulse');
                }, 1000);
            });
        }
    });
</script>