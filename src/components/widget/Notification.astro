---
interface Props {
	class?: string;
}

const className = Astro.props.class;
---

<div id="notification-container" class:list={["notification-container", className]}>
	<div id="notification-wrapper" class="notification-wrapper"></div>
</div>

<style is:global>
	.notification-container {
		position: fixed;
		top: 24px;
		left: 24px;
		z-index: 88888;
		display: flex;
		flex-direction: column;
		gap: 12px;
		pointer-events: none;
		max-width: 400px;
		width: calc(100vw - 48px);
	}

	.notification-wrapper {
		display: flex;
		flex-direction: column;
		gap: 12px;
	}

	.notification-item {
		position: relative;
		background: #ffffff;
		border-radius: 16px;
		padding: 0;
		box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
		pointer-events: auto;
		overflow: hidden;
		animation: notification-slide-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
		transform-origin: top left;
		border: 1px solid rgba(0, 0, 0, 0.05);
		transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
	}

	.notification-item::before {
		content: '';
		position: absolute;
		left: 0;
		top: 0;
		bottom: 0;
		width: 4px;
		background: var(--primary, #6366f1);
		border-radius: 16px 0 0 16px;
	}

	.notification-item.type-success::before {
		background: #10b981;
	}

	.notification-item.type-error::before {
		background: #ef4444;
	}

	.notification-item.type-warning::before {
		background: #f59e0b;
	}

	.notification-item.type-info::before {
		background: var(--primary, #6366f1);
	}

	:root.dark .notification-item {
		background: #1e202c;
		box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25), 0 2px 8px rgba(0, 0, 0, 0.15);
		border: 1px solid rgba(255, 255, 255, 0.1);
	}

	.notification-item.closing {
		animation: notification-slide-out 0.35s cubic-bezier(0.4, 0, 1, 1) forwards;
	}

	.notification-inner {
		padding: 16px 20px 16px 24px;
		display: flex;
		flex-direction: column;
		gap: 8px;
	}

	.notification-header {
		display: flex;
		align-items: center;
		gap: 12px;
	}

	.notification-icon-wrapper {
		flex-shrink: 0;
		width: 36px;
		height: 36px;
		border-radius: 10px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: rgba(0, 0, 0, 0.04);
	}

	.notification-item.type-success .notification-icon-wrapper {
		background: rgba(16, 185, 129, 0.1);
	}

	.notification-item.type-error .notification-icon-wrapper {
		background: rgba(239, 68, 68, 0.1);
	}

	.notification-item.type-warning .notification-icon-wrapper {
		background: rgba(245, 158, 11, 0.1);
	}

	.notification-item.type-info .notification-icon-wrapper {
		background: rgba(99, 102, 241, 0.1);
	}

	:root.dark .notification-icon-wrapper {
		background: rgba(255, 255, 255, 0.08);
	}

	:root.dark .notification-item.type-success .notification-icon-wrapper {
		background: rgba(16, 185, 129, 0.15);
	}

	:root.dark .notification-item.type-error .notification-icon-wrapper {
		background: rgba(239, 68, 68, 0.15);
	}

	:root.dark .notification-item.type-warning .notification-icon-wrapper {
		background: rgba(245, 158, 11, 0.15);
	}

	:root.dark .notification-item.type-info .notification-icon-wrapper {
		background: rgba(99, 102, 241, 0.15);
	}

	.notification-icon {
		width: 20px;
		height: 20px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.notification-icon svg {
		width: 100%;
		height: 100%;
	}

	.notification-title-wrapper {
		flex: 1;
		display: flex;
		flex-direction: column;
		gap: 2px;
		min-width: 0;
	}

	.notification-title {
		font-weight: 600;
		font-size: 14px;
		color: #1e293b;
		letter-spacing: -0.01em;
	}

	:root.dark .notification-title {
		color: #f1f5f9;
	}

	.notification-content {
		font-size: 13px;
		color: #64748b;
		line-height: 1.5;
		padding-right: 28px;
	}

	:root.dark .notification-content {
		color: #94a3b8;
	}

	.notification-close {
		position: absolute;
		top: 12px;
		right: 12px;
		width: 28px;
		height: 28px;
		border: none;
		background: rgba(0, 0, 0, 0.04);
		cursor: pointer;
		opacity: 0.6;
		transition: all 0.2s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 8px;
		padding: 0;
		color: #64748b;
	}

	.notification-close:hover {
		opacity: 1;
		background: rgba(0, 0, 0, 0.08);
		transform: scale(1.05);
	}

	.notification-close:active {
		transform: scale(0.95);
	}

	:root.dark .notification-close {
		background: rgba(255, 255, 255, 0.06);
		color: #94a3b8;
	}

	:root.dark .notification-close:hover {
		background: rgba(255, 255, 255, 0.1);
	}

	.notification-close svg {
		width: 14px;
		height: 14px;
	}

	.notification-progress-wrapper {
		position: absolute;
		bottom: 0;
		left: 4px;
		right: 0;
		height: 3px;
		background: rgba(0, 0, 0, 0.05);
		overflow: hidden;
	}

	:root.dark .notification-progress-wrapper {
		background: rgba(255, 255, 255, 0.05);
	}

	.notification-progress {
		position: absolute;
		top: 0;
		left: 0;
		height: 100%;
		background: var(--primary, #6366f1);
		animation: notification-progress linear forwards;
		border-radius: 0 2px 2px 0;
	}

	:root.dark .notification-progress {
		background: var(--primary, #818cf8);
	}

	.notification-item.type-success .notification-progress {
		background: #10b981;
	}

	.notification-item.type-error .notification-progress {
		background: #ef4444;
	}

	.notification-item.type-warning .notification-progress {
		background: #f59e0b;
	}

	.notification-item.type-info .notification-progress {
		background: var(--primary, #6366f1);
	}

	.notification-item:hover .notification-progress {
		animation-play-state: paused;
	}

	.notification-item.stacked-1 {
		transform: translateX(8px) scale(0.98);
		opacity: 0.95;
		filter: brightness(0.98);
	}

	.notification-item.stacked-2 {
		transform: translateX(16px) scale(0.96);
		opacity: 0.85;
		filter: brightness(0.96);
	}

	.notification-item.stacked-3 {
		transform: translateX(24px) scale(0.94);
		opacity: 0.75;
		filter: brightness(0.94);
	}

	.notification-item.stacked-4,
	.notification-item.stacked-5,
	.notification-item.stacked-6,
	.notification-item.stacked-7,
	.notification-item.stacked-8,
	.notification-item.stacked-9 {
		transform: translateX(32px) scale(0.92);
		opacity: 0.65;
		filter: brightness(0.92);
	}

	@keyframes notification-slide-in {
		0% {
			opacity: 0;
			transform: translateX(-120%) scale(0.85) rotateY(-10deg);
		}
		50% {
			opacity: 1;
		}
		100% {
			opacity: 1;
			transform: translateX(0) scale(1) rotateY(0);
		}
	}

	@keyframes notification-slide-out {
		0% {
			opacity: 1;
			transform: translateX(0) scale(1);
		}
		100% {
			opacity: 0;
			transform: translateX(-100%) scale(0.9);
		}
	}

	@keyframes notification-progress {
		from {
			width: 100%;
		}
		to {
			width: 0%;
		}
	}

	@media (max-width: 480px) {
		.notification-container {
			top: 12px;
			left: 12px;
			max-width: calc(100vw - 24px);
		}

		.notification-inner {
			padding: 14px 16px 14px 20px;
		}

		.notification-icon-wrapper {
			width: 32px;
			height: 32px;
		}

		.notification-title {
			font-size: 13px;
		}

		.notification-content {
			font-size: 12px;
		}
	}
</style>

<script>
	export interface NotificationOptions {
		title?: string;
		message: string;
		type?: 'info' | 'success' | 'warning' | 'error';
		duration?: number;
		closable?: boolean;
	}

	export interface WelcomeNotificationConfig {
		enable: boolean;
		title?: string;
		message: string;
		type?: 'info' | 'success' | 'warning' | 'error';
		duration?: number;
		closable?: boolean;
		delay?: number;
	}

	class NotificationManager {
		private static instance: NotificationManager | null = null;
		private container: HTMLElement | null = null;
		private wrapper: HTMLElement | null = null;
		private notifications: Map<string, HTMLElement> = new Map();
		private counter = 0;
		private baseZIndex = 88888;

		static getInstance(): NotificationManager {
			if (!NotificationManager.instance) {
				NotificationManager.instance = new NotificationManager();
			}
			return NotificationManager.instance;
		}

		init() {
			this.container = document.getElementById('notification-container');
			this.wrapper = document.getElementById('notification-wrapper');
			this.logSystemInfo();
		}

		getStatus(): { initialized: boolean; containerReady: boolean; wrapperReady: boolean } {
			return {
				initialized: !!(this.container || this.wrapper),
				containerReady: !!this.container,
				wrapperReady: !!this.wrapper
			};
		}

		getQueueCount(): number {
			return this.notifications.size;
		}

		private logSystemInfo() {
			console.group('%cüì¢ Notification System Info', 'color: #6366f1; font-size: 14px; font-weight: bold;');
			console.log('%cÂÆπÂô®Áä∂ÊÄÅ:', 'color: #10b981; font-weight: bold;');
			console.log('  ‚îú‚îÄ Container:', this.container ? '‚úÖ Â∑≤ÊâæÂà∞' : '‚ùå Êú™ÊâæÂà∞');
			console.log('  ‚îú‚îÄ Wrapper:', this.wrapper ? '‚úÖ Â∑≤ÊâæÂà∞' : '‚ùå Êú™ÊâæÂà∞');
			console.log('  ‚îî‚îÄ Âü∫Á°Ä Z-Index:', this.baseZIndex);
			console.log('%cÊ¨¢ËøéÈÄöÁü•ÈÖçÁΩÆ:', 'color: #f59e0b; font-weight: bold;');
			const welcomeConfig = getWelcomeConfig();
			console.log('  ‚îú‚îÄ ÂêØÁî®Áä∂ÊÄÅ:', welcomeConfig.enable ? '‚úÖ Â∑≤ÂêØÁî®' : '‚ùå Â∑≤Á¶ÅÁî®');
			console.log('  ‚îú‚îÄ Á±ªÂûã:', welcomeConfig.type);
			console.log('  ‚îú‚îÄ ÊåÅÁª≠Êó∂Èó¥:', welcomeConfig.duration + 'ms');
			console.log('  ‚îú‚îÄ ÂèØÂÖ≥Èó≠:', welcomeConfig.closable ? 'ÊòØ' : 'Âê¶');
			console.log('  ‚îî‚îÄ Âª∂ËøüÊòæÁ§∫:', welcomeConfig.delay + 'ms');
			console.log('%cAPI ÊñπÊ≥ï:', 'color: #8b5cf6; font-weight: bold;');
			console.log('  ‚îú‚îÄ notification.show(options)');
			console.log('  ‚îú‚îÄ notification.info(message, title?)');
			console.log('  ‚îú‚îÄ notification.success(message, title?)');
			console.log('  ‚îú‚îÄ notification.warning(message, title?)');
			console.log('  ‚îú‚îÄ notification.error(message, title?)');
			console.log('  ‚îú‚îÄ notification.close(id)');
			console.log('  ‚îî‚îÄ notification.setWelcomeConfig(config)');
			console.groupEnd();
		}

		show(options: NotificationOptions): string {
			if (!this.wrapper) {
				this.init();
			}

			if (!this.wrapper) {
				console.warn('Notification container not found');
				return '';
			}

			const id = `notification-${++this.counter}`;
			const baseDuration = options.duration ?? 7000;
			const type = options.type ?? 'info';
			const closable = options.closable ?? true;
			const stackOffset = this.notifications.size * 8000;
			const duration = baseDuration + stackOffset;

			console.group(`%cüì¨ ÈÄöÁü•ÊòæÁ§∫ [${id}]`, 'color: #6366f1; font-weight: bold;');
			console.log('%cÂèÇÊï∞‰ø°ÊÅØ:', 'color: #10b981; font-weight: bold;');
			console.log('  ‚îú‚îÄ Ê†áÈ¢ò:', options.title || '(Êó†)');
			console.log('  ‚îú‚îÄ Ê∂àÊÅØ:', options.message);
			console.log('  ‚îú‚îÄ Á±ªÂûã:', type);
			console.log('  ‚îú‚îÄ Âü∫Á°ÄÊåÅÁª≠Êó∂Èó¥:', baseDuration + 'ms');
			console.log('  ‚îú‚îÄ Â†ÜÂè†ÂÅèÁßª:', stackOffset + 'ms');
			console.log('  ‚îú‚îÄ ÂÆûÈôÖÊåÅÁª≠Êó∂Èó¥:', duration + 'ms');
			console.log('  ‚îú‚îÄ ÂèØÂÖ≥Èó≠:', closable ? 'ÊòØ' : 'Âê¶');
			console.log('  ‚îî‚îÄ ÂΩìÂâçÈòüÂàóÊï∞Èáè:', this.notifications.size + 1);
			console.groupEnd();

			const notification = document.createElement('div');
			notification.className = `notification-item type-${type}`;
			notification.id = id;
			notification.style.zIndex = String(this.baseZIndex - this.notifications.size);

			this.updateStackedClasses();

			const iconSvg = this.getIcon(type);

			notification.innerHTML = `
				<div class="notification-inner">
					<div class="notification-header">
						<div class="notification-icon-wrapper">
							<div class="notification-icon">${iconSvg}</div>
						</div>
						<div class="notification-title-wrapper">
							${options.title ? `<div class="notification-title">${this.escapeHtml(options.title)}</div>` : ''}
							<div class="notification-content">${this.escapeHtml(options.message)}</div>
						</div>
					</div>
				</div>
				${closable ? `
					<button class="notification-close" aria-label="ÂÖ≥Èó≠ÈÄöÁü•">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
							<path d="M18 6L6 18M6 6l12 12"/>
						</svg>
					</button>
				` : ''}
				<div class="notification-progress-wrapper">
					<div class="notification-progress" style="animation-duration: ${duration}ms;"></div>
				</div>
			`;

			if (closable) {
				const closeBtn = notification.querySelector('.notification-close');
				if (closeBtn) {
					closeBtn.addEventListener('click', () => this.close(id));
				}
			}

			this.wrapper.appendChild(notification);
			this.notifications.set(id, notification);

			setTimeout(() => {
				this.close(id);
			}, duration);

			return id;
		}

		close(id: string) {
			const notification = this.notifications.get(id);
			if (!notification) return;

			console.log(`%cüì™ ÈÄöÁü•ÂÖ≥Èó≠ [${id}]`, 'color: #ef4444; font-weight: bold;', `Ââ©‰ΩôÈÄöÁü•: ${this.notifications.size - 1}`);

			notification.classList.add('closing');
			
			setTimeout(() => {
				notification.remove();
				this.notifications.delete(id);
				this.updateZIndices();
			}, 350);
		}

		private updateZIndices() {
			const notifications = Array.from(this.notifications.values());
			notifications.forEach((notification, index) => {
				notification.style.zIndex = String(this.baseZIndex - index);
			});
			this.updateStackedClasses();
		}

		private updateStackedClasses() {
			const notifications = Array.from(this.notifications.values());
			notifications.forEach((notification, index) => {
				for (let i = 1; i <= 9; i++) {
					notification.classList.remove(`stacked-${i}`);
				}
				if (index > 0) {
					const stackLevel = Math.min(index, 9);
					notification.classList.add(`stacked-${stackLevel}`);
				}
			});
		}

		private getIcon(type: string): string {
			const icons: Record<string, string> = {
				info: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2.5" stroke-linecap="round">
					<circle cx="12" cy="12" r="9"/>
					<path d="M12 8v4M12 16h.01"/>
				</svg>`,
				success: `<svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
					<circle cx="12" cy="12" r="9"/>
					<path d="M9 12l2 2 4-4"/>
				</svg>`,
				warning: `<svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2.5" stroke-linecap="round">
					<path d="M12 9v4M12 16h.01"/>
					<path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
				</svg>`,
				error: `<svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round">
					<circle cx="12" cy="12" r="9"/>
					<path d="M15 9l-6 6M9 9l6 6"/>
				</svg>`
			};
			return icons[type] || icons.info;
		}

		private escapeHtml(text: string): string {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}
	}

	const notificationManager = NotificationManager.getInstance();

	function getWelcomeConfig(): WelcomeNotificationConfig {
		if (!(window as any).notificationWelcomeConfig) {
			(window as any).notificationWelcomeConfig = {
				enable: true,
				title: 'Ê¨¢ËøéËÆøÈóÆ‚ÄùAUNya„ÅÆÂ∞èÁ™ù‚Äú',
				message: 'È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÁ•ùÊÇ®ÊµèËßàÊÑâÂø´ÔºÅ',
				type: 'success',
				duration: 7000,
				closable: true,
				delay: 500
			};
		}
		return (window as any).notificationWelcomeConfig;
	}

	function showWelcomeNotification() {
		const welcomeConfig = getWelcomeConfig();
		if (welcomeConfig && welcomeConfig.enable !== false) {
			console.log('%cüéâ Ê¨¢ËøéÈÄöÁü•ÂáÜÂ§áÊòæÁ§∫', 'color: #10b981; font-weight: bold;', `Âª∂Ëøü: ${welcomeConfig.delay || 300}ms`);
			setTimeout(() => {
				notificationManager.show({
					title: welcomeConfig.title || 'Ê¨¢Ëøé',
					message: welcomeConfig.message || 'È°µÈù¢Âä†ËΩΩÂÆåÊàê',
					type: welcomeConfig.type || 'info',
					duration: welcomeConfig.duration || 7000,
					closable: welcomeConfig.closable !== false
				});
			}, welcomeConfig.delay || 300);
		} else {
			console.log('%c‚ö†Ô∏è Ê¨¢ËøéÈÄöÁü•Â∑≤Á¶ÅÁî®', 'color: #f59e0b; font-weight: bold;');
		}
	}

	function initNotification() {
		notificationManager.init();
	}

	function setupWelcomeNotification() {
		const pageLoader = document.getElementById('page-loader');
		
		if (pageLoader) {
			const isHidden = pageLoader.classList.contains('loader-hidden') || pageLoader.style.display === 'none';
			
			if (isHidden) {
				showWelcomeNotification();
			} else {
				const observer = new MutationObserver(() => {
					const nowHidden = pageLoader.classList.contains('loader-hidden') || pageLoader.style.display === 'none';
					if (nowHidden) {
						observer.disconnect();
						showWelcomeNotification();
					}
				});
				observer.observe(pageLoader, { 
					attributes: true, 
					attributeFilter: ['class', 'style'] 
				});
			}
		} else {
			if (document.readyState === 'complete') {
				showWelcomeNotification();
			} else {
				window.addEventListener('load', () => {
					showWelcomeNotification();
				});
			}
		}
	}

	function init() {
		console.log('%cüîß ÈÄöÁü•Á≥ªÁªüÂàùÂßãÂåñ‰∏≠...', 'color: #8b5cf6; font-weight: bold;');
		initNotification();
		setupWelcomeNotification();
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', init);
	} else {
		init();
	}

	document.addEventListener('astro:page-load', () => {
		initNotification();
	});

	function createNotificationAPI() {
		return {
			show: (options: NotificationOptions) => notificationManager.show(options),
			info: (message: string, title?: string) => notificationManager.show({ message, title, type: 'info' }),
			success: (message: string, title?: string) => notificationManager.show({ message, title, type: 'success' }),
			warning: (message: string, title?: string) => notificationManager.show({ message, title, type: 'warning' }),
			error: (message: string, title?: string) => notificationManager.show({ message, title, type: 'error' }),
			close: (id: string) => notificationManager.close(id),
			setWelcomeConfig: (config: Partial<WelcomeNotificationConfig>) => {
				(window as any).notificationWelcomeConfig = { ...getWelcomeConfig(), ...config };
			},
			getStatus: () => notificationManager.getStatus(),
			getQueueCount: () => notificationManager.getQueueCount()
		};
	}

	(window as any).notification = createNotificationAPI();

	export const notification = createNotificationAPI();
</script>
