---
import { announcementConfig } from "../../config";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import WidgetLayout from "./WidgetLayout.astro";
import { getEntry, render } from "astro:content";
import Markdown from "../misc/Markdown.astro";

const config = announcementConfig;

const announcementPost = await getEntry("spec", "announcement");
let AnnouncementContent = null;

if (announcementPost) {
	const { Content } = await render(announcementPost);
	AnnouncementContent = Content;
}

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
---

<WidgetLayout 
    name={config.title || i18n(I18nKey.announcement)} 
    id="announcement"
    class={className} 
    style={style}
>
    <div>
        <div id="announcement-content" class="text-neutral-600 dark:text-neutral-300 leading-relaxed mb-3">
            {AnnouncementContent ? (
                <AnnouncementContent />
            ) : (
                <Markdown>
                    {config.content}
                </Markdown>
            )}
        </div>
        
        <div class="flex items-center gap-3">
            {config.link && config.link.enable !== false && (
                <a 
                    href={config.link.url} 
                    target={config.link.external ? "_blank" : "_self"}
                    rel={config.link.external ? "noopener noreferrer" : undefined}
                    class="btn-regular rounded-lg px-3 py-1.5 text-sm font-medium active:scale-95 transition-transform"
                >
                    {config.link.text}
                </a>
            )}
        </div>
    </div>
</WidgetLayout>

<script>
    function closeAnnouncement() {
        const widgetLayout = document.querySelector('widget-layout[data-id="announcement"]');
        if (widgetLayout) {
            widgetLayout.style.display = 'none';
            localStorage.setItem('announcementClosed', 'true');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const widgetLayout = document.querySelector('widget-layout[data-id="announcement"]');
        if (widgetLayout && localStorage.getItem('announcementClosed') === 'true') {
            widgetLayout.style.display = 'none';
        }
    });

    window.closeAnnouncement = closeAnnouncement;
</script>